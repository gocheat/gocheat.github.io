---
layout: single
title:  "Hands-on Production Monitoring System - #1"
date: 2021-03-08
tags: [Prometheus, Grafana, 모니터링, 운영, 인프라, 자동화, SRE, CNCF, 오픈소스]
categories: monitoring
---

해당 포스팅을 통해 실제 운영중인 서비스에 **프로메테우스**, **그라파나**, **알림매니저**를 이용하여 운영 모니터링 시스템 구축한 사례에 대해 공유하고자 합니다.

## 개요 

어떤 프로젝트든지 중간 단계 정도`(코드가 계속해서 커밋되고 있고 이를 테스트할 서버가 있는 단계)`가 되었을때 앞으로 운영을 할때 어떤식으로 모니터링을 할지, 로그는 어떤식으로 추적할지에 대해 고려하게 됩니다.
(물론 노하우가 있는 팀이라면 처음 설계 단계부터 정해지는 경우도 있겠지만)

제가 개발을 담당하고 있던 프로젝트 또한 그러한 성숙 단계가 되었고 모니터링에 대해 고려 해야하는 시점에 왔습니다. 

우선 결론부터 말씀드리자면 아래와 오픈소스를 활용하여 모니터링 시스템을 구축하게 되었습니다.

- 메트릭 수집: node exporter, 라이브러리 사용
- 모니터링: Prometheus
- 시각화: Grafana
- 관리자 알림: Alertmanager, 자체 알림 서비스 구축 

우선 위와 같은 모니터링 오픈소스를 선택하는데 있어서는 **크게 고민하지 않았습니다.** 우선 타 엔터프라이즈급 서비스에서 프로메테우스 기반으로 구축된 아키텍처를 쉽게 접할 수 있었고(`카카오, 배민등등`),
무엇보다 CNCF(<https://www.cncf.io/projects>)에서 이미 Graduated 단계의 오픈소스이기 때문에 어느정도 검증 되었다고 판단하였습니다.
> CNCF란? Cloud Native Computing Foundation 는 대표적으로 Kubernetes 와 Prometheus  와 같은 클라우드 네이티브 오픈소스 기술들을 추진하고 관리하는 단체입니다.

그리고 결정적으로 툴이 중요한것이 아니라 **무엇을 모니터링할지**가 중요한 포인트이기 때문에 기술,아키턱처 트랜드에 휩쓸리지 않도록 주의를 했습니다.

## 서비스 신뢰성 수준 설정

실제로 모니터링을 할 타겟 및 목적에 대해서는 구글의 SRE(사이트 신뢰성 엔지니어링) 서적을 많이 참조 하였는데, 해당 서적에서 말하는
**서비스의 신뢰성에 대한 명확한 정의**와 가용성 목표 및 장애발생에 대한 예측 및 자동 복구등을 고려하여 아래와 같은 구체적인 SLI 세웠습니다.

### 1. VM 서버 신뢰성 지표
-  VM이 종료 된 비율 
-  VM내 메모리가 XX% 이상 초과 했는가?
-  VM내 CPU가 XX% 이상 초과 했는가?
-  VM내 Disk가 XX% 이상 초과 했는가?

### 2. B/E 신뢰성 지표
-  B/E서비스가 종료 된 비율
-  B/E서비스의 GET 요청의 응답 시간이 XX초 이상이 99퍼 이상인가?
-  B/E서비스의 DELETE/PUT/CREATE 요청의 응답 시간이 XX초 이상이 99퍼 이상인가?
-  B/E서비스의 TPS는 XX 인가?
-  B/E서비스의 200와 4XX,5XX 에러의 비율이 XX% 이상인가?

### 3. 데이터베이스 신뢰성 지표
-  Count를 제외한 Query가 XX이상 초과 하는것이 있는가?

_더 많은 신뢰성 세부 지표가 있었지만, 해당 포스트에선 생략 했습니다._
